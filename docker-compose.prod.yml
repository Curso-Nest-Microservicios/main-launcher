version: '3'

services:
  nats-server:
    image: nats:latest

  # Cliente gateway, punto de entrada Rest.    
  cliente-gateway:
    build:
      context: ./cliente-gateway
      dockerfile: dockerfile.prod
    image: cliente-gateway-prod
    ports:
      - ${CLIENTE_GATEWAY_PORT}:${CLIENTE_GATEWAY_PORT}
    environment:
      - PORT=${CLIENTE_GATEWAY_PORT}
      - NATS_SERVERS=nats://nats-server:4222

  # Microservicio de Auth-Ms.
  auth-ms:
    build:
      context: ./auth-ms
      dockerfile: dockerfile.prod
    image: auth-ms
    environment:
      - PORT=3004
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=${AUTH_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}

  # Microservicio de Productos.
  productos-ms:
    build:
      context: ./productos-ms
      dockerfile: dockerfile.prod
    image: productos-ms
    environment:
      - PORT=3001
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=file:./dev.db

  # Microservicio de Pagos.
  pagos-ms:
    build:
      context: ./pagos-ms
      dockerfile: dockerfile.prod
    image: pagos-ms
    ports:
      - ${PAGOS_MS_PORT}:${PAGOS_MS_PORT}    
    environment:
      - PORT=${PAGOS_MS_PORT}
      - NATS_SERVERS=nats://nats-server:4222
      - STRIPE_SECRET=${STRIPE_SECRET}
      - STRIPE_SUCCESS_URL=${STRIPE_SUCCESS_URL}
      - STRIPE_CANCEL_URL=${STRIPE_CANCEL_URL}
      - STRIPE_LOCALE=${STRIPE_LOCALE}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET}


  # # Microservicio de Órdenes.
  # ordenes-ms:
  #   depends_on:
  #     - ordenes-db
  #   build: ./ordenes-ms
  #   volumes:
  #     - ./ordenes-ms/src:/usr/src/app/src
  #   command: npm run start:dev
  #   environment:
  #     - PORT=3002
  #     - NATS_SERVERS=nats://nats-server:4222
  #     - DATABASE_URL=postgresql://postgres:postgres@ordenes-db:5432/ordenes?schema=public

  # # Base de datos para Órdenes.
  # ordenes-db:
  #   container_name: ordenes_database
  #   image: postgres:16.2
  #   restart: always
  #   volumes:
  #     - ./ordenes-ms/postgres:/var/lib/postgresql/data
  #   ports:
  #     - 5432:5432
  #   environment:
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=postgres
  #     - POSTGRES_DB=ordenes
